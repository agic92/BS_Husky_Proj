V 13
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 
PANEL,-1 -1 621 412 N "_3DFace" 2
"$ZNAK"
"$ZNAK_DP"
"#uses \"CtrlXmlRpc\"

main(){
  Prikazi_Znak_Na_Panelu();
  readSignPanelSingle($ZNAK_DP);  
}  

//string sys_name = \"SysSarani:\";
string xmlRpcMethodReadSettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentSignPanel\";
string xmlRpcMethodReadDisplaySettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentPortalSignPanel\";
string xmlRpcMethodReadMatrixSettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentMatrixSignPanel\";
string xmlRpcMethodReadBrightness = \"bstelecom.sign.SignProtocolAdapter.readSignBrightness\";
string xmlRpcMethodReadDisplayLoopSettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentPortal_PetljaSignPanel\";

void readSignPanelSingle(string nazivZnaka)
{
  //DebugFTN(\"level1\", \"readSignPanelSingle before delay\");
  delay(1); 
  //DebugFTN(\"level1\", \"readSignPanelSingle after delay\");
  
  string id = \"servID\" + rand();
  string host = \"10.101.0.1\";
  int port = \"8087\";
  bool secure = FALSE;
  
  xmlrpcClient();
  xmlrpcConnectToServer(id, host, port, secure);

  string ip_adresa;
  int tipZnaka, status;
    
  dpGet(sys_name + nazivZnaka + \".status\", status);
  dpGet(sys_name + nazivZnaka + \".IP\", ip_adresa);
  dpGet(sys_name + nazivZnaka + \".tip_znaka\", tipZnaka);
  
  //trenutno se salje na znak
  if(status == 1){
    DebugFTN(\"level1\", \"znak: \" + nazivZnaka + \" -- status: \" + status);
    //delay(1);   
    //return; //trenutno se salje na znak
  }
  
  //vrijednosti koje dobijemo kad procitamo sa znaka
  mapping readCurrentSign;
  //tip znaka je prvi parametar koji prosljedjujemo funkciji
  dyn_mixed argsSign = makeDynMixed(tipZnaka, ip_adresa);
  
  xmlrpcCall(id, xmlRpcMethodReadDisplayLoopSettings, argsSign, readCurrentSign);
 
  dyn_errClass err = getLastError(); //test whether an error occurred 
  if(dynlen(err) > 0) 
  { 
     errorDialog(err); 
     // open dialog box with errors
     DebugFTN(\"level1\", \"readSignPanelSingle: err: \" ,err); 
     //throwError(err); // write errors to stderr 
  } 
  
  DebugFTN(\"level1\", \"readSignPanelSingle: tipZnaka: \" + tipZnaka + \", ip_adresa: \" + ip_adresa + \", readCurrentSign: \", readCurrentSign);
  
  setPortalLoopDatapoint(tipZnaka, nazivZnaka, readCurrentSign, status);      
  xmlrpcCloseServer(id);  
}

setPortalLoopDatapoint(int tip_znaka, string nazivZnaka, mapping readCurrentSign, int status){
       
  int Active, Duration, Bgr1, Bgr2, Fn1, Fn2, Fn3;
  int Active_2, Duration_2, Bgr1_2, Bgr2_2, Fn1_2, Fn2_2, Fn3_2;
		string sText, sText_2;
  
  DebugFTN(\"level1\", \"Portal Values: \", readCurrentSign);
  
  //smjesti u varijablu vrijednost piktograma
  Active = readCurrentSign[\"Active0\"];
  Duration = readCurrentSign[\"Duration0\"];
  
  //ako nema komunikacije sa znakom vrati postavi status -1
  if(Active == -1 || Duration == -1){
    dpSet(sys_name + nazivZnaka + \".status\", -1);  
  }
  else{      
    //kad uspije procitati postavi status na 0
    dpSet(sys_name + nazivZnaka + \".status\", 0); 
    Bgr1 = readCurrentSign[\"Bgr10\"];
    Bgr2 = readCurrentSign[\"Bgr20\"];
    sText = readCurrentSign[\"sText0\"];
  
    //smjesti u varijablu vrijednost piktograma
    Active_2 = readCurrentSign[\"Active1\"];
    Duration_2 = readCurrentSign[\"Duration1\"];
    Bgr1_2 = readCurrentSign[\"Bgr11\"];
    Bgr2_2 = readCurrentSign[\"Bgr21\"];
    sText_2 = readCurrentSign[\"sText1\"];
  
    dyn_int izborZnaka = makeDynInt(Active, Duration, Bgr1, Bgr2, Active_2, Duration_2, Bgr1_2, Bgr2_2);
  
    DebugFTN(\"level1\", \"Portal Values: \" + izborZnaka, \"  TEXT PANEL1: \" + sText + \"  TEXT PANEL2: \" + sText_2);
  
    strreplace(sText, \"'nl'\", \"-NL-\"); 
    strreplace(sText_2, \"'nl'\", \"-NL-\");  
    dpSet(sys_name + nazivZnaka + \".response.izbor_znaka\", izborZnaka);
    
    //dodati varijablu text_portal
    dpSet(sys_name + nazivZnaka + \".response.text_portal\", sText);
    dpSet(sys_name + nazivZnaka + \".response.text_portal_2\", sText_2);
   
  }
}














void Prikazi_Znak_Na_Panelu(){  
  int rc;  
  
  if( !dpExists(sys_name + $ZNAK_DP + \".response.izbor_znaka\"))
  {
    setValue(\"\", \"color\", \"_dpdoesnotexist\");
    return;
  }
  
  rc = dpConnect(\"ShowSign\", sys_name + $ZNAK_DP + \".response.izbor_znaka\", sys_name + $ZNAK_DP + \".response.izbor_znaka:_online.._bad\");
  
  if ( sdGetLastError() < 0 || rc != 0)
    setValue(\"\", \"color\", \"_dpdoesnotexist\");    
}

 void ShowSign(string dp, dyn_int niz_int, string dp2, bool bInvalid){
  if(bInvalid)
    setValue(\"\", \"color\", \"_dpdoesnotexist\");
  else
    setValue(\"\", \"color\", \"\");
  
  int Active, Duration, Bgr1, Bgr2;
  int Active_2, Duration_2, Bgr1_2, Bgr2_2;
		string sText, sText_2;
 
  //smjesti u varijablu vrijednost piktograma
  Active = niz_int[1];
  Duration = niz_int[2];
  Bgr1 = niz_int[3];
  Bgr2 = niz_int[4];
  
  //smjesti u varijablu vrijednost piktograma
  Active_2 = niz_int[5];
  Duration_2 = niz_int[6];
  Bgr1_2 = niz_int[7];
  Bgr2_2 = niz_int[8]; 
  
  showSign(niz_int, Active_2, Bgr1, Bgr2, Duration);
}  

string get_file(int broj){
  return \"Znakovi portal/BGR/\" + broj + \".wmf\";
}

showSign(dyn_int niz_int, int Active_2, int Bgr1,int Bgr2, int Duration){
  
  string sText, sText_2;
  int Bgr1_2, Bgr2_2;

  sdShowBitmap(\"bgr1\", 1, true, get_file(Bgr1)); 
  sdShowBitmap(\"bgr2\", 1, true, get_file(Bgr2)); 
  
  dpGet(sys_name + $ZNAK_DP + \".response.text_portal\", sText);
  strreplace(sText, \"-NL-\", \"\\n\");
  setValue(\"text_portal\", \"text\", sText);
  
  if(Active_2){   
    while(true){       
      dpGet(sys_name + $ZNAK_DP + \".response.izbor_znaka\", niz_int);
      dpGet(sys_name + $ZNAK_DP + \".response.text_portal_2\", sText_2);
      dpGet(sys_name + $ZNAK_DP + \".response.text_portal\", sText);
      
      Bgr1 = niz_int[3]; 
      Bgr1_2 = niz_int[7];
      Bgr2 = niz_int[4];
      Bgr2_2 = niz_int[8];
      
      sdShowBitmap(\"bgr1\", 1, true, get_file(Bgr1));
      sdShowBitmap(\"bgr2\", 1, true, get_file(Bgr2));
      strreplace(sText, \"-NL-\", \"\\n\");
      strreplace(sText, \"TIME\", formatTime(\"%H:%M\", getCurrentTime()));
      
      setValue(\"text_portal\", \"text\", sText); ;
      delay(Duration/10);
      sdShowBitmap(\"bgr1\", 1, true, get_file(Bgr1_2)); 
      sdShowBitmap(\"bgr2\", 1, true, get_file(Bgr2_2));
      strreplace(sText_2, \"-NL-\", \"\\n\");
      strreplace(sText_2, \"TIME\", formatTime(\"%H:%M\", getCurrentTime()));
      setValue(\"text_portal\", \"text\", sText_2);  
      delay(Duration/10);    
    }  
  } 
}

" 0
 E E E E 1 -1 -1 0  15.49999615744065 13
""0  1
E E 3
"CBRef" "1"
"EClose" E
"dpi" "96.0946"
0 0 0
""
DISPLAY_LAYER, 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0
LAYER, 0 
2
LANG:10024 0 
LANG:10027 0 
30 1
"FRAME1"
""
1 12 25 E E E 1 E 1 E N "_WindowText" E N {0,0,0} E E
 E E
0 0 0 0 0 0
E E E
1
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 

2
"dashclr"N "_Transparent"
"antiAliased" "0"
"main()
{
  //setValue(\"\",\"text\",$ZNAK_LIJEVI);
  string vr = substr($ZNAK, 0, strpos($ZNAK, \".\", 0));
  //string vr = substr($ZNAK_LIJEVI, 0, strpos($ZNAK_LIJEVI, \".\", 0));
  setValue(\"\",\"text\",vr);
}" 0
 E 0 1 1 2 1 E 1.503807116351674 0 1.164596273291926 -0.5456892387794312 -14.11490683229812 0 E 12 25 407 348
3
LANG:10024 36 Times New Roman,-1,13,5,50,0,0,0,0,0
LANG:10027 36 Times New Roman,-1,13,5,50,0,0,0,0,0
LANG:10001 36 Times New Roman,-1,13,5,50,0,0,0,0,0
0 3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 
2 2
"PRIMITIVE_TEXT1"
""
1 23.40718562874262 77 E E E 1 E 1 E N "_WindowText" E N "_Window" E E
 E E
1 0 0 0 0 0
E E E
0
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 

3
"sizePolicy" "Fixed Fixed"
"dashclr"N "_Transparent"
"antiAliased" "1"
E E 0 1 1 2 1 E U  0 E 23.40718562874262 77 160.4071856287426 101
0 2 2 "0s" 0 0 0 64 0 0  23.40718562874262 77 1
2
LANG:10024 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10027 26 Arial,-1,16,5,50,0,0,0,0,0
0 3
LANG:10024 7 Status:
LANG:10027 13 Статус:
LANG:10001 8 Status: 
14 8
"TEXT_FIELD2"
""
1 214 100.5 E E E 1 E 1 E N "_WindowText" E N "_Window" E E
 E E
7 0 0 0 0 0
E E E
0
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 

0
3
LANG:10024 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10027 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10001 26 Arial,-1,16,5,50,0,0,0,0,0
0  213 71 523 98
2 "0s" 0 0 0 1 0 -1  E "#uses \"latin_to_cyrillic.ctl\"

main()
{
  int status;
  dpGet(sys_name + $ZNAK + \".status\", status);
  
  if(status == -10) setValue(\"\",\"text\",latinToCyrillic(\"Različito na znaku i na SCADA-i\"));
  else if(status == -1) setValue(\"\",\"text\",latinToCyrillic(\"Greška u komunikaciji sa znakom\"));
  else if(status == -9) setValue(\"\",\"text\",latinToCyrillic(\"Greška u komunikaciji sa adapterom\"));
  else if(status == -8) setValue(\"\",\"text\",latinToCyrillic(\"Greška u komunikaciji sa znakom\"));
  else if(status == -2) setValue(\"\",\"text\",latinToCyrillic(\"Uspostavljena komunikacija sa znakom\"));
  else setValue(\"\",\"text\",latinToCyrillic(\"OK\"));
  
}" 0
 E
13 19
"PUSH_BUTTON1"
""
1 214 127 E E E 1 E 1 E N "WF_Text" E N "_Button" E E
 E E
18 0 0 0 0 0
E E E
0
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 

0
3
LANG:10024 32 DejaVu Sans,-1,12,5,75,0,0,0,0,0
LANG:10027 32 DejaVu Sans,-1,12,5,75,0,0,0,0,0
LANG:10001 37 MS Shell Dlg 2,8.25,-1,5,50,0,0,0,0,0
0  213 112 407 156

T 
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 28 OČITAJ VRIJEDNOSTI SA ZNAKA
"#uses \"CtrlXmlRpc\"

int main() 
{
  readSignPanelSingle($ZNAK_DP);
}

//string sys_name = \"SysSarani:\";
string xmlRpcMethodReadSettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentSignPanel\";
string xmlRpcMethodReadDisplaySettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentPortalSignPanel\";
string xmlRpcMethodReadMatrixSettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentMatrixSignPanel\";
string xmlRpcMethodReadBrightness = \"bstelecom.sign.SignProtocolAdapter.readSignBrightness\";
string xmlRpcMethodReadDisplayLoopSettings = \"bstelecom.sign.SignProtocolAdapter.readCurrentPortal_PetljaSignPanel\";

void readSignPanelSingle(string nazivZnaka)
{
  //DebugFTN(\"level1\", \"readSignPanelSingle before delay\");
  delay(1); 
  //DebugFTN(\"level1\", \"readSignPanelSingle after delay\");
  
  string id = \"servID\" + rand();
  string host = \"10.101.0.1\";
  int port = \"8087\";
  bool secure = FALSE;
  
  xmlrpcClient();
  xmlrpcConnectToServer(id, host, port, secure);

  string ip_adresa;
  int tipZnaka, status;
    
  dpGet(sys_name + nazivZnaka + \".status\", status);
  dpGet(sys_name + nazivZnaka + \".IP\", ip_adresa);
  dpGet(sys_name + nazivZnaka + \".tip_znaka\", tipZnaka);
  
  //trenutno se salje na znak
  if(status == 1){
    DebugFTN(\"level1\", \"znak: \" + nazivZnaka + \" -- status: \" + status);
    //delay(1);   
    //return; //trenutno se salje na znak
  }
  
  //vrijednosti koje dobijemo kad procitamo sa znaka
  mapping readCurrentSign;
  //tip znaka je prvi parametar koji prosljedjujemo funkciji
  dyn_mixed argsSign = makeDynMixed(tipZnaka, ip_adresa);
  
  xmlrpcCall(id, xmlRpcMethodReadDisplayLoopSettings, argsSign, readCurrentSign);
 
  dyn_errClass err = getLastError(); //test whether an error occurred 
  if(dynlen(err) > 0) 
  { 
     errorDialog(err); 
    // open dialog box with errors
     DebugFTN(\"level1\", \"readSignPanelSingle: err: \" ,err); 
    //throwError(err); // write errors to stderr 
  } 
  
  DebugFTN(\"level1\", \"readSignPanelSingle: tipZnaka: \" + tipZnaka + \", ip_adresa: \" + ip_adresa + \", readCurrentSign: \", readCurrentSign);
  
  setPortalLoopDatapoint(tipZnaka, nazivZnaka, readCurrentSign, status);      
  xmlrpcCloseServer(id);  
}

setPortalLoopDatapoint(int tip_znaka, string nazivZnaka, mapping readCurrentSign, int status){
       
  int Active, Duration, Bgr1, Bgr2, Fn1, Fn2, Fn3;
  int Active_2, Duration_2, Bgr1_2, Bgr2_2, Fn1_2, Fn2_2, Fn3_2;
		string sText, sText_2;
  
  DebugFTN(\"level1\", \"Portal Values: \", readCurrentSign);
  
  //smjesti u varijablu vrijednost piktograma
  Active = readCurrentSign[\"Active0\"];
  Duration = readCurrentSign[\"Duration0\"];
  
  //ako nema komunikacije sa znakom vrati postavi status -1
  if(Active == -1 || Duration == -1){
    dpSet(sys_name + nazivZnaka + \".status\", -1);  
  }
  else{      
    //kad uspije procitati postavi status na 0
    dpSet(sys_name + nazivZnaka + \".status\", 0); 
    Bgr1 = readCurrentSign[\"Bgr10\"];
    Bgr2 = readCurrentSign[\"Bgr20\"];
    sText = readCurrentSign[\"sText0\"];
  
    //smjesti u varijablu vrijednost piktograma
    Active_2 = readCurrentSign[\"Active1\"];
    Duration_2 = readCurrentSign[\"Duration1\"];
    Bgr1_2 = readCurrentSign[\"Bgr11\"];
    Bgr2_2 = readCurrentSign[\"Bgr21\"];
    sText_2 = readCurrentSign[\"sText1\"];
  
    dyn_int izborZnaka = makeDynInt(Active, Duration, Bgr1, Bgr2, Active_2, Duration_2, Bgr1_2, Bgr2_2);
  
    DebugFTN(\"level1\", \"Portal Values: \" + izborZnaka, \"  TEXT PANEL1: \" + sText + \"  TEXT PANEL2: \" + sText_2);
  
    strreplace(sText, \"'nl'\", \"-NL-\"); 
    strreplace(sText_2, \"'nl'\", \"-NL-\");  
    dpSet(sys_name + nazivZnaka + \".response.izbor_znaka\", izborZnaka);
    
    //dodati varijablu text_portal
    dpSet(sys_name + nazivZnaka + \".response.text_portal\", sText);
    dpSet(sys_name + nazivZnaka + \".response.text_portal_2\", sText_2);
   
  }
}

" 0
 E E "main()
{
  this.text = latinToCyrillic(\"Očitaj vrednosti sa znaka\");
}" 0

2 22
"PRIMITIVE_TEXT14"
""
1 31 286 E E E 1 E 1 E N "_WindowText" E N "_Window" E E
 E E
21 0 0 0 0 0
E E E
0
2
LANG:10024 0 
LANG:10027 0 

3
"sizePolicy" "Fixed Fixed"
"dashclr"N "_Transparent"
"antiAliased" "0"
E E 0 1 1 2 1 E 1.023952095808383 0 1 -8.287425149700482 -247 0 E 31 286 193 302
0 2 2 "0s" 0 0 0 192 0 0  31 286 1
2
LANG:10024 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10027 26 Arial,-1,16,5,50,0,0,0,0,0
0 2
LANG:10024 20 Informacije o znaku:
LANG:10027 37 Информације о знаку:
2 26
"PRIMITIVE_TEXT18"
""
1 31 286 E E E 1 E 1 E N "_WindowText" E N "_Window" E E
 E E
25 0 0 0 0 0
E E E
0
2
LANG:10024 0 
LANG:10027 0 

3
"sizePolicy" "Fixed Fixed"
"dashclr"N "_Transparent"
"antiAliased" "0"
E E 0 1 1 2 1 E 1.023952095808383 0 1 -8.287425149700482 -10.92172399093954 0 E 31 286 166 302
0 2 2 "0s" 0 0 0 192 0 0  31 286 1
2
LANG:10024 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10027 26 Arial,-1,16,5,50,0,0,0,0,0
0 2
LANG:10024 18 Trenutno na znaku:
LANG:10027 33 Тренутно на знаку:
6 27
"RECTANGLE8"
""
1 90 260 E E E 1 E 1 E N "_Transparent" E N {0,0,0} E E
 E E
26 0 0 0 0 0
E E E
0
2
LANG:10024 0 
LANG:10027 0 

2
"dashclr"N "_Transparent"
"antiAliased" "0"
E E 0 1 1 2 1 E 5.366666666666666 0 1.365362066515659 -266.3592814371256 -114.9158612850107 1 E 90 260 150 320
6 28
"bgr1"
""
1 90 260 E E E 1 E 1 E N "_Transparent" E N "White" E E
 E E
27 0 0 0 0 0
E E E
0
2
LANG:10024 0 
LANG:10027 0 

2
"dashclr"N "_Transparent"
"antiAliased" "0"
E E 0 1 1 2 1 E 1.316666666666667 0 1.316666666666667 99.1407185628743 -101.2550573242729 1 E 90 260 150 320
6 29
"bgr2"
""
1 90 260 E E E 1 E 1 E N "_Transparent" E N "White" E E
 E E
28 0 0 0 0 0
E E E
0
2
LANG:10024 0 
LANG:10027 0 

2
"dashclr"N "_Transparent"
"antiAliased" "0"
E E 0 1 1 2 1 E 1.316666666666667 0 1.3084375 340.1407185628742 -99.11645244105277 1 E 90 260 150 320
2 34
"text_portal"
""
1 377.1675865091632 252.1845260090603 E E E 1 E 1 E N "white" E N "_Window" E E
 E E
33 0 0 0 0 0
E E E
0
2
LANG:10024 0 
LANG:10027 0 

3
"sizePolicy" "Fixed Fixed"
"dashclr"N "_Transparent"
"antiAliased" "0"
E E 0 1 1 2 1 E U  0 E 377.1675865091632 252.1845260090603 378 272
0 2 2 "0s" 0 0 0 193 0 0  377.1675865091632 252.1845260090603 1
2
LANG:10024 36 Liberation Sans,-1,19,5,50,0,0,0,0,0
LANG:10027 36 Liberation Sans,-1,19,5,50,0,0,0,0,0
0 2
LANG:10024 0 
LANG:10027 0 
14 35
"TEXT_FIELD4"
""
1 215 66 E E E 1 E 1 E N "_WindowText" E N "_Window" E E
 E E
34 0 0 0 0 0
E E E
0
3
LANG:10024 0 
LANG:10027 0 
LANG:10001 0 

0
3
LANG:10024 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10027 26 Arial,-1,16,5,50,0,0,0,0,0
LANG:10001 26 Arial,-1,16,5,50,0,0,0,0,0
0  214 36 524 63
2 "0s" 0 0 0 1 0 -1  E "#uses \"latin_to_cyrillic.ctl\"

main()
{
  setValue(\"\",\"text\", latinToCyrillic($ZNAK_DP));
}" 0
 E
0
LAYER, 1 
2
LANG:10024 0 
LANG:10027 0 
0
LAYER, 2 
2
LANG:10024 0 
LANG:10027 0 
0
LAYER, 3 
2
LANG:10024 0 
LANG:10027 0 
0
LAYER, 4 
2
LANG:10024 0 
LANG:10027 0 
0
LAYER, 5 
2
LANG:10024 0 
LANG:10027 0 
0
LAYER, 6 
2
LANG:10024 0 
LANG:10027 0 
0
LAYER, 7 
2
LANG:10024 0 
LANG:10027 0 
0
0
